<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Mael Uber</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      font-family: Arial, sans-serif;
    }
    header {
      background: #0e0f0f;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 20px;
      font-weight: bold;
    }
    #map { flex: 1; width: 100%; }
    footer {
      text-align: center;
      padding: 10px;
      background: #f0f0f0;
    }
    button {
      background: #1e88e5;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: #1568b4; }
    #cobranca {
      margin-top: 10px;
      text-align: center;
    }
    #valorTotal {
      background-color: #1e88e5;
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: bold;
      display: inline-block;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      margin-top: 10px;
    }
    #enderecos { text-align:center; margin:10px; }
    #enderecos table { margin:auto; }
    #enderecos input { padding: 6px; width: 250px; }
    #sugestoesDestino div:hover { background: #cce5ff; }
  </style>
</head>
<body>
  <header>Mael Uber</header>

  <!-- Tabela de endere√ßos -->
  <div id="enderecos">
    <table>
      <tr>
        <td>Origem:</td>
        <td><input type="text" id="inputOrigem" placeholder="Digite a origem"></td>
      </tr>
      <tr>
        <td>Destino:</td>
        <td><input type="text" id="inputDestino" placeholder="Digite o destino" oninput="buscarSugestoes()"></td>
      </tr>
    </table>
    <button onclick="definirRota()">Tra√ßar Rota</button>
    <div id="sugestoesDestino" style="text-align:center; margin-top:5px;"></div>
  </div>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Rodap√© -->
  <footer>
    <button onclick="iniciarCorrida()">Iniciar Corrida</button>
    <div id="cobranca">
      <h3><span id="valorTotal">Valor da corrida: R$ <span id="valor">0.00</span></span></h3>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([0, 0], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let origem, destino, rota;
    let marcadorOrigem, marcadorDestino;

    // Tenta pegar localiza√ß√£o do usu√°rio
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        origem = [pos.coords.latitude, pos.coords.longitude];
        document.getElementById("inputOrigem").value = `${origem[0]}, ${origem[1]}`;
        marcadorOrigem = L.marker(origem).addTo(map).bindPopup("Voc√™ est√° aqui!").openPopup();
        map.setView(origem, 15);
      });
    }

    // Calcula cobran√ßa
    function calcularCobranca(origem, destino) {
      const distanciaMetros = map.distance(origem, destino);
      const distanciaKm = distanciaMetros / 1000;
      const tarifa = 2.5;
      const valorTotal = distanciaKm * tarifa;
      document.getElementById("valor").textContent = valorTotal.toFixed(2);
    }

    // Converte endere√ßo para coordenadas (Nominatim)
    async function enderecoParaCoords(endereco) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`);
      const data = await response.json();
      if (data.length === 0) return null;
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }

    // Tra√ßar rota pelo input
    async function definirRota() {
      const origemInput = document.getElementById("inputOrigem").value;
      const destinoInput = document.getElementById("inputDestino").value;
      if (!origemInput || !destinoInput) {
        alert("‚ö†Ô∏è Digite origem e destino!");
        return;
      }

      // Se input foi digitado, transforma em coordenadas
      origem = await enderecoParaCoords(origemInput) || origem;
      destino = await enderecoParaCoords(destinoInput);
      if (!destino) {
        alert("Destino n√£o encontrado!");
        return;
      }

      // Remove marcadores antigos
      if (marcadorOrigem) map.removeLayer(marcadorOrigem);
      if (marcadorDestino) map.removeLayer(marcadorDestino);

      // Adiciona marcadores
      marcadorOrigem = L.marker(origem).addTo(map).bindPopup("Origem").openPopup();
      marcadorDestino = L.marker(destino).addTo(map).bindPopup("Destino").openPopup();

      // Tra√ßar rota
      const url = `https://router.project-osrm.org/route/v1/driving/${origem[1]},${origem[0]};${destino[1]},${destino[0]}?overview=full&geometries=geojson`;
      const rotaResponse = await fetch(url);
      const rotaData = await rotaResponse.json();
      const coords = rotaData.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);

      if (rota) map.removeLayer(rota);
      rota = L.polyline(coords, {color: 'blue'}).addTo(map);
      map.fitBounds(rota.getBounds());

      calcularCobranca(origem, destino);
    }

    // Fun√ß√£o de autocomplete
    async function buscarSugestoes() {
      const query = document.getElementById("inputDestino").value;
      const sugestoesDiv = document.getElementById("sugestoesDestino");
      sugestoesDiv.innerHTML = "";

      if (query.length < 3) return;

      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
      const data = await response.json();

      data.forEach(item => {
        const div = document.createElement("div");
        div.textContent = item.display_name;
        div.style.cursor = "pointer";
        div.style.background = "#f0f0f0";
        div.style.padding = "5px";
        div.style.margin = "2px auto";
        div.style.width = "250px";
        div.addEventListener("click", () => {
          document.getElementById("inputDestino").value = item.display_name;
          sugestoesDiv.innerHTML = "";
          definirRota();
        });
        sugestoesDiv.appendChild(div);
      });
    }

    // Iniciar corrida
    function iniciarCorrida() {
      if (origem && destino) {
        const valor = document.getElementById("valor").textContent;
        alert(`üöñ Corrida iniciada!\nOrigem: ${origem}\nDestino: ${destino}\nValor: R$ ${valor}`);
      } else {
        alert("‚ö†Ô∏è Digite origem e destino antes de iniciar a corrida!");
      }
    }
  </script>
</body>
</html>
